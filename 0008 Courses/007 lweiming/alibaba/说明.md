## nacos











动态刷新 和 回滚

@RefreshScope

回滚操作

1.1.2 回滚有bug

应用配置共享



配置一个 不指定环境的 配置即可共享



不同应用之间的共享

share-dataids

ext-config





优先级

share-dataids <  xt-config 自动



引导上下文

bootstrap 是 application context 的父子上下文





远程配置 本地配置





数据持久化





# 认证与授权

有状态 无 状态

session store



强制下线



处处安全方案

OAuth 2.0 系列文章 

http://ifeve.com/oauth2-tutorial-all







## sentinel

https://github.com/alibaba/Sentinel/releases/download/1.7.0/sentinel-dashboard-1.7.0.jar



没有实现仓壁模式

短路没有半开状态

Sphu

Tracer

ContextUtil



@SentinelResource 不支持来源 ContextUtil

类 处理服务降级

类 处理服务限流



忽略统计





没有设置半开状态



设置超时

​	释放时间快

设置限流

​	

仓壁模式

​	独立线程池

断路器模式

​	监控

​	三态转换



```yaml
management:
  endpoints:
    web:
      exposure:
        include: '*'
```



```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<!-- 端点暴露 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

访问

```html
http://ip:port/actuator/sentinel
http://localhost:8888/actuator/sentinel
```



```yaml
spring:
 cloud:
  sentinel:
   filter:
    # 关闭对Spring MVC端点的保护
    enable: false
   transport:
    port: 8080
    # sentinel 控制台地址
    dashboard: localhost:8080
```

流控规则

```html
流控模式
# 直接
Blocked by Sentinel (flow limiting)
# 关联
保护关联资源的设计 所关联的超过一定“量”，则限流 此路径
# 链路
当前api被调用超过一定“量”时，则入口资源被限流


流控效果
快速失败
com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController

warm up
阀值/codeFactor的值 经过预热时长 才会达到设置的QPS阀值
https://github.com/alibaba/Sentinel/wiki/QPS流量控制

com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController

排队等待
匀速排队， 请求以匀速的速度通过，阀值类型必须设置为QPS 否则无效
有坑
com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController
```

问题

应用重启会丢失流控规则



降级规则

RT 平均响应时间

默认最大4900ms



热点规则

热点参数 提升api可用性

系统规则

uptime。 1 5 15



授权规则





### 代码配置规则





原理分析





@SentinelRestTemplate

```yaml
# 开发调试时
resttemplate：
 sentinel：
  # 关闭@SentinelRestTemplate 注解
  enabled: false
```



FeginSentinel

```yaml
fegin:
 # 整合fegin
 sentinel:
  enabled: true
```

如何处理返回结果



如何获取异常

fallbackFactory







规则持久化

拉模式

存储到 本地

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-extension</artifactId>
</dependency>
```



resource/META-INF/services

 com.alibaba.csp.sentinel.init.InitFunc

com...FileDataSourceInit



推模式

先推送到nacos 微服务 会监听其变化



推荐一种：

https://ahas.console.aliyun.com

https://help.aliyun.com.document_detail/90323.html





集群流控

Token Server Token Client

独立模式

嵌入模式



不支持 选举 故障转移





CommonFilter

错误优化

怎么区分 降级 还是优化

UrlBlockHanlder 

异常处理

RequestOrignParser

来源支持



UrlCleaner

重新定义资源名称







实现异步的方法

@AsynRestTemplate



@Async



WebClient



## MQ

异步处理

流量消峰填谷

解锁为服务



Kafka Rabbit RocketMQ ActiveMQ





### RocketMQ

http://rocketmq.apache.org/docs/quick-start/

```shell
nohup sh bin/mqnamesrv &
tail -f ~/logs/rocketmqlogs/namesrv.log
The Name Server boot success...
```

https://github.com/apache/rocketmq-externals



开发者指南





分布式事物

实现分布式事物操作demo

statistic



p3c



SonarQube





jconsole

jvisualVM



GC



GCEasy			GCPlot

FastThread	 spring bootadmin

HeapHero		jvisualvm





ELK



Logstash  -- Fluentd -- Filebeat